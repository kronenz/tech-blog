# Feature Specification: AnimFlow DSL Engine

**Feature Branch**: `001-animflow-dsl-engine`
**Created**: 2025-11-26
**Status**: Draft
**Input**: User description: "AnimFlow DSL 엔진 - 선언적 다이어그램 정의 언어 파서, 렌더러, 시나리오 엔진 구현"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - DSL 기반 다이어그램 렌더링 (Priority: P1)

콘텐츠 작성자는 YAML 파일에 다이어그램 구조(노드, 엣지, 스타일)를 정의하고, 이를 즉시 시각적 다이어그램으로 확인할 수 있다. 이를 통해 코드 작성 없이 기술 다이어그램을 생성할 수 있다.

**Why this priority**: 다이어그램 렌더링은 AnimFlow의 가장 기본적인 기능이며, 이것 없이는 다른 모든 기능이 의미가 없다. MVP의 핵심 가치를 제공한다.

**Independent Test**: YAML 파일 하나를 작성하고 브라우저에서 열면 노드와 연결선이 있는 다이어그램이 표시되는 것으로 완전히 테스트 가능하다.

**Acceptance Scenarios**:

1. **Given** 유효한 AnimFlow YAML 파일이 있을 때, **When** 렌더러가 파일을 로드하면, **Then** 정의된 모든 노드가 지정된 위치에 표시된다
2. **Given** 노드 간 연결(엣지)이 정의되어 있을 때, **When** 다이어그램이 렌더링되면, **Then** 화살표가 있는 연결선이 노드 사이에 표시된다
3. **Given** 노드에 스타일(색상, 모양)이 지정되어 있을 때, **When** 렌더링되면, **Then** 해당 스타일이 적용된 노드가 표시된다
4. **Given** YAML 파일에 문법 오류가 있을 때, **When** 파싱을 시도하면, **Then** 오류 위치와 원인을 알려주는 메시지가 표시된다

---

### User Story 2 - 시나리오 기반 애니메이션 실행 (Priority: P2)

콘텐츠 작성자는 YAML에 시나리오(단계별 애니메이션 시퀀스)를 정의하고, 사용자가 "시작" 버튼을 누르면 정의된 순서대로 노드와 엣지가 하이라이트되며 애니메이션이 실행된다.

**Why this priority**: 정적 다이어그램만으로는 기존 Mermaid와 차별화되지 않는다. 애니메이션은 AnimFlow의 핵심 차별점이며 P1 완료 후 즉시 필요하다.

**Independent Test**: 시나리오가 정의된 YAML을 로드하고 시작 버튼을 클릭하면 순차적으로 노드/엣지가 하이라이트되는 것으로 테스트 가능하다.

**Acceptance Scenarios**:

1. **Given** 시나리오에 3개의 스텝이 정의되어 있을 때, **When** 시작 버튼을 클릭하면, **Then** 스텝 1 → 스텝 2 → 스텝 3 순서로 애니메이션이 실행된다
2. **Given** 스텝에 duration이 1000ms로 지정되어 있을 때, **When** 해당 스텝이 실행되면, **Then** 약 1초간 하이라이트 상태가 유지된다
3. **Given** 애니메이션이 진행 중일 때, **When** 리셋 버튼을 클릭하면, **Then** 다이어그램이 초기 상태로 돌아간다
4. **Given** 스텝에 로그 메시지가 정의되어 있을 때, **When** 해당 스텝이 실행되면, **Then** 로그 패널에 메시지가 표시된다

---

### User Story 3 - 조건부 분기 및 변수 시스템 (Priority: P3)

콘텐츠 작성자는 변수를 정의하고 조건부 분기(if/else)를 사용하여 캐시 히트/미스 같은 다양한 시나리오를 하나의 파일에서 표현할 수 있다. 랜덤 값을 사용하여 실제 시스템 동작을 시뮬레이션할 수 있다.

**Why this priority**: 조건부 분기는 복잡한 시스템 플로우(캐시, 에러 처리 등)를 표현하는 데 필수적이지만, 기본 애니메이션 없이는 구현 및 테스트가 불가능하다.

**Independent Test**: 변수와 조건문이 포함된 시나리오를 실행하면 조건에 따라 다른 경로의 애니메이션이 실행되는 것으로 테스트 가능하다.

**Acceptance Scenarios**:

1. **Given** 변수 `cacheHit: true`가 설정되어 있을 때, **When** `if cacheHit:` 조건이 평가되면, **Then** then 블록의 스텝들이 실행된다
2. **Given** 변수 `hit = random(0.8)`이 설정되어 있을 때, **When** 시나리오를 여러 번 실행하면, **Then** 약 80% 확률로 hit이 true가 된다
3. **Given** `goto: other-scenario`가 스텝에 있을 때, **When** 해당 스텝이 실행되면, **Then** 지정된 시나리오로 이동하여 계속 실행된다
4. **Given** 통계 업데이트 `stat jwt-time = 0.1`이 있을 때, **When** 스텝이 실행되면, **Then** 통계 패널에 해당 값이 표시된다

---

### User Story 4 - 사용자 컨트롤 UI (Priority: P4)

사용자는 시나리오 선택 버튼, 속도 조절, 시작/리셋 버튼을 통해 다이어그램과 상호작용할 수 있다. 이러한 컨트롤은 YAML에 선언적으로 정의된다.

**Why this priority**: 사용자 경험을 크게 향상시키지만, 기본 애니메이션 기능 없이는 의미가 없다.

**Independent Test**: 컨트롤이 정의된 YAML을 로드하면 버튼과 속도 조절 UI가 표시되고 동작하는 것으로 테스트 가능하다.

**Acceptance Scenarios**:

1. **Given** 3개의 시나리오가 정의되어 있을 때, **When** 다이어그램이 로드되면, **Then** 각 시나리오를 선택할 수 있는 버튼 그룹이 표시된다
2. **Given** 속도 옵션(느림, 보통, 빠름)이 정의되어 있을 때, **When** "빠름"을 선택하면, **Then** 이후 애니메이션 스텝의 duration이 짧아진다
3. **Given** default: true인 시나리오가 있을 때, **When** 다이어그램이 로드되면, **Then** 해당 시나리오가 기본 선택되어 있다

---

### User Story 5 - 통계 및 로그 패널 (Priority: P5)

사용자는 애니메이션 실행 중 실시간 통계(응답 시간, 캐시 히트율 등)와 시스템 로그를 확인할 수 있다. 이를 통해 시스템 동작을 더 깊이 이해할 수 있다.

**Why this priority**: 교육적 가치를 높이는 기능이지만, 핵심 애니메이션 기능 완료 후 추가되어야 한다.

**Independent Test**: 통계와 로그가 정의된 시나리오를 실행하면 패널에 값이 업데이트되는 것으로 테스트 가능하다.

**Acceptance Scenarios**:

1. **Given** stats 섹션에 `jwt-time`이 정의되어 있을 때, **When** 다이어그램이 로드되면, **Then** "JWT 검증 시간" 통계 카드가 표시된다
2. **Given** 스텝에서 `stat jwt-time = 0.1`이 실행될 때, **When** 해당 스텝이 완료되면, **Then** 통계 패널에 "0.1 ms"가 표시된다
3. **Given** logging.enabled: true일 때, **When** 로그 메시지가 있는 스텝이 실행되면, **Then** 타임스탬프와 함께 로그 패널에 메시지가 추가된다
4. **Given** 로그 항목이 20개를 초과할 때, **When** 새 로그가 추가되면, **Then** 가장 오래된 로그가 제거된다

---

### Edge Cases

- 노드 ID가 중복되어 있을 때 파싱 에러를 표시해야 한다
- 존재하지 않는 노드 ID를 참조하는 엣지는 검증 에러를 표시해야 한다
- 빈 시나리오(스텝이 없는)를 실행하면 즉시 완료 상태가 되어야 한다
- goto로 무한 루프가 발생할 경우 최대 실행 횟수 제한을 적용해야 한다
- 캔버스 크기가 지정되지 않았을 때 기본값(1200x800)을 사용해야 한다
- YAML이 아닌 형식(XML, 일반 텍스트)이 입력되면 명확한 에러 메시지를 표시해야 한다

## Requirements *(mandatory)*

### Functional Requirements

**DSL 파서**
- **FR-001**: 시스템은 AnimFlow YAML 형식의 파일을 파싱하여 내부 데이터 구조로 변환해야 한다
- **FR-002**: 시스템은 JSON Schema 기반으로 YAML 구조의 유효성을 검증해야 한다
- **FR-003**: 시스템은 파싱/검증 오류 발생 시 오류 위치(줄/열)와 설명을 제공해야 한다
- **FR-004**: 시스템은 AnimFlow JSON 형식도 지원해야 한다

**렌더러**
- **FR-005**: 시스템은 노드를 지정된 위치(x, y)에 렌더링해야 한다
- **FR-006**: 시스템은 box, circle, database 등 다양한 노드 타입을 지원해야 한다
- **FR-007**: 시스템은 노드 간 연결선(엣지)을 화살표와 함께 렌더링해야 한다
- **FR-008**: 시스템은 solid, dashed, dotted 등 다양한 선 스타일을 지원해야 한다
- **FR-009**: 시스템은 노드와 엣지에 라벨 텍스트를 표시해야 한다
- **FR-010**: 시스템은 캔버스 영역(section)을 구분하여 표시할 수 있어야 한다

**시나리오 엔진**
- **FR-011**: 시스템은 시나리오의 스텝들을 순차적으로 실행해야 한다
- **FR-012**: 시스템은 highlight, animate-edge, delay 등 액션 타입을 지원해야 한다
- **FR-013**: 시스템은 스텝별 duration을 준수하여 애니메이션 타이밍을 제어해야 한다
- **FR-014**: 시스템은 변수 설정(set) 및 참조($var)를 지원해야 한다
- **FR-015**: 시스템은 조건부 분기(conditional)를 지원해야 한다
- **FR-016**: 시스템은 랜덤 값 표현식(probability, min/max)을 지원해야 한다
- **FR-017**: 시스템은 시나리오 간 이동(goto)을 지원해야 한다
- **FR-018**: 시스템은 무한 루프 방지를 위해 최대 스텝 실행 횟수를 제한해야 한다 (기본: 1000)

**UI 컴포넌트**
- **FR-019**: 시스템은 시작/리셋 버튼을 제공해야 한다
- **FR-020**: 시스템은 시나리오 선택 버튼 그룹을 렌더링해야 한다
- **FR-021**: 시스템은 애니메이션 속도 조절 UI를 제공해야 한다
- **FR-022**: 시스템은 통계 패널에 정의된 stat 값들을 표시해야 한다
- **FR-023**: 시스템은 로그 패널에 시간순으로 로그 메시지를 표시해야 한다
- **FR-024**: 시스템은 범례(legend)를 표시할 수 있어야 한다

**DSL v2 간결 문법 (선택적 확장)**
- **FR-025**: 시스템은 v2 간결 문법(`client --> backend: Request`)을 v1 형식으로 내부 변환하여 지원해야 한다

### Key Entities

- **Diagram**: 전체 다이어그램을 나타내는 최상위 개체. 메타데이터, 캔버스 설정, 노드, 엣지, 시나리오를 포함한다.
- **Node**: 다이어그램의 개별 구성 요소. ID, 라벨, 위치, 타입, 스타일 속성을 가진다.
- **Edge**: 두 노드 간의 연결. 출발 노드, 도착 노드, 라벨, 선 스타일 속성을 가진다.
- **Scenario**: 애니메이션 시퀀스. ID, 이름, 초기화 변수, 스텝 목록을 포함한다.
- **Step**: 시나리오 내 개별 애니메이션 액션. 액션 타입, 대상, duration, 스타일, 로그 메시지 등을 포함한다.
- **Variable**: 런타임 상태 값. 타입(boolean, number, string)과 값을 가진다.
- **Control**: 사용자 인터랙션 요소. 버튼 그룹, 속도 선택 등의 타입과 옵션을 포함한다.
- **Stat**: 통계 항목. ID, 라벨, 단위, 현재 값을 가진다.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 사용자는 50줄 이내의 YAML 파일로 10개 이상의 노드와 15개 이상의 연결선을 가진 다이어그램을 정의할 수 있다
- **SC-002**: 다이어그램 초기 로딩(파싱 + 첫 렌더링)이 1초 이내에 완료된다 (30개 노드 기준)
- **SC-003**: 애니메이션이 60fps 프레임 레이트를 유지하며 부드럽게 실행된다
- **SC-004**: YAML 문법 오류 발생 시 3초 이내에 오류 위치와 설명이 표시된다
- **SC-005**: 기존 `caching-flow-diagram.html`의 모든 기능을 AnimFlow DSL로 동일하게 구현할 수 있다
- **SC-006**: 비개발자(기술 작가, 교육자)가 30분 이내에 기본 다이어그램을 생성할 수 있다
- **SC-007**: 5개의 시나리오와 20개의 스텝이 있는 다이어그램이 오류 없이 모든 시나리오를 완료할 수 있다

## Assumptions

- 대상 브라우저는 모던 브라우저(Chrome, Firefox, Safari, Edge)의 최신 2개 버전을 지원한다
- Canvas 2D API를 기본 렌더러로 사용한다 (추후 SVG, WebGL 옵션 추가 가능)
- YAML 파싱에는 js-yaml 라이브러리를 사용한다
- JSON Schema 검증에는 ajv 라이브러리를 사용한다
- 최대 노드 수는 100개, 최대 엣지 수는 200개로 가정한다 (성능 최적화 범위)
- 로그 패널은 최근 20개 항목을 표시한다
- 무한 루프 방지를 위한 최대 스텝 실행 횟수는 1000회로 설정한다
