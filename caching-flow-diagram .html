<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDAP + Keycloak + OPA ë©€í‹° ë ˆì´ì–´ ìºì‹± í”Œë¡œìš°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .scenario-group {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .scenario-label {
            font-weight: 600;
            color: #495057;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-scenario {
            background: white;
            color: #495057;
            border: 2px solid #dee2e6;
            padding: 10px 18px;
            font-size: 13px;
        }

        .btn-scenario:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-1px);
        }

        .btn-scenario.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-reset {
            background: #6c757d;
            color: white;
        }

        .btn-reset:hover {
            background: #5a6268;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-control label {
            font-weight: 600;
            color: #495057;
        }

        select {
            padding: 8px 15px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .legend {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .legend-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 12px;
            color: #212529;
        }

        .legend-items {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 30px;
            height: 4px;
            border-radius: 2px;
        }

        .canvas-container {
            padding: 40px;
            background: white;
            position: relative;
        }

        #canvas {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stats {
            padding: 30px;
            background: #f8f9fa;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-title {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #212529;
        }

        .stat-unit {
            font-size: 0.8em;
            color: #6c757d;
        }

        .message-log {
            padding: 30px;
            background: #212529;
            color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }

        .message-log-title {
            font-weight: 700;
            margin-bottom: 15px;
            color: #10b981;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-left: 3px solid #6c757d;
            padding-left: 12px;
        }

        .log-entry.success {
            border-left-color: #10b981;
            color: #10b981;
        }

        .log-entry.error {
            border-left-color: #ef4444;
            color: #ef4444;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
            color: #3b82f6;
        }

        .log-entry.warning {
            border-left-color: #f59e0b;
            color: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulsing {
            animation: pulse 1s ease-in-out infinite;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #212529;
            color: #adb5bd;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ” LDAP + Keycloak + OPA ë©€í‹° ë ˆì´ì–´ ìºì‹± í”Œë¡œìš°</h1>
            <p class="subtitle">ì¸í„°ë™í‹°ë¸Œ ì¸ì¦/ì¸ê°€ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì‹œë®¬ë ˆì´í„°</p>
        </header>

        <div class="controls">
            <button class="btn-start" onclick="startSimulation()">â–¶ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
            <button class="btn-reset" onclick="resetSimulation()">â†» ë¦¬ì…‹</button>
            
            <div class="scenario-group">
                <span class="scenario-label">ì‹œë‚˜ë¦¬ì˜¤:</span>
                <button class="btn-scenario active" onclick="setScenario('random')" data-scenario="random">
                    ğŸ² ëœë¤
                </button>
                <button class="btn-scenario" onclick="setScenario('no-cache')" data-scenario="no-cache">
                    âŒ ìºì‹œ ì—†ìŒ
                </button>
                <button class="btn-scenario" onclick="setScenario('partial-cache')" data-scenario="partial-cache">
                    âš¡ ë¶€ë¶„ ìºì‹œ
                </button>
                <button class="btn-scenario" onclick="setScenario('full-cache')" data-scenario="full-cache">
                    âœ… ì „ì²´ ìºì‹œ
                </button>
            </div>
            
            <div class="speed-control">
                <label for="speed">ì• ë‹ˆë©”ì´ì…˜ ì†ë„:</label>
                <select id="speed" onchange="updateSpeed()">
                    <option value="2000">ëŠë¦¼</option>
                    <option value="1000" selected>ë³´í†µ</option>
                    <option value="500">ë¹ ë¦„</option>
                    <option value="200">ë§¤ìš° ë¹ ë¦„</option>
                </select>
            </div>
        </div>

        <div class="legend">
            <div class="legend-title">ë²”ë¡€</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>ìºì‹œ íˆíŠ¸ (Cache Hit)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>ìºì‹œ ë¯¸ìŠ¤ (Cache Miss)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3b82f6;"></div>
                    <span>ì¼ë°˜ ìš”ì²­</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>ìºì‹œ ì €ì¥</span>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-title">JWT ê²€ì¦ ì‹œê°„</div>
                <div class="stat-value"><span id="jwt-time">-</span> <span class="stat-unit">ms</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-title">OPA í‰ê°€ ì‹œê°„</div>
                <div class="stat-value"><span id="opa-time">-</span> <span class="stat-unit">ms</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ì´ ì‘ë‹µ ì‹œê°„</div>
                <div class="stat-value"><span id="total-time">-</span> <span class="stat-unit">ms</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ìºì‹œ íˆíŠ¸ìœ¨</div>
                <div class="stat-value"><span id="hit-rate">-</span> <span class="stat-unit">%</span></div>
            </div>
        </div>

        <div class="stats" style="background: #fff3cd; border-top: 2px solid #ffc107; padding: 20px 30px;">
            <div class="stat-card" style="background: #fff; grid-column: 1 / -1;">
                <div class="stat-title" style="font-size: 1.1em; margin-bottom: 15px;">ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ë³„ ì„±ëŠ¥ ë¹„êµ</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px; color: #495057;">
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ef4444;">
                        <strong>âŒ ìºì‹œ ì—†ìŒ</strong><br>
                        <span style="font-size: 20px; font-weight: 700; color: #212529;">~25ms</span><br>
                        <span style="color: #6c757d;">ê¸°ì¤€ì„  (0% ê°œì„ )</span>
                    </div>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <strong>âš¡ ë¶€ë¶„ ìºì‹œ</strong><br>
                        <span style="font-size: 20px; font-weight: 700; color: #212529;">~3-10ms</span><br>
                        <span style="color: #6c757d;">40-88% ê°œì„ </span>
                    </div>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #10b981;">
                        <strong>âœ… ì „ì²´ ìºì‹œ</strong><br>
                        <span style="font-size: 20px; font-weight: 700; color: #212529;">~2ms</span><br>
                        <span style="color: #6c757d;">92% ê°œì„ </span>
                    </div>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <strong>ğŸ² ëœë¤</strong><br>
                        <span style="font-size: 20px; font-weight: 700; color: #212529;">~2-15ms</span><br>
                        <span style="color: #6c757d;">ì‹¤ì œ í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="message-log">
            <div class="message-log-title">ğŸ“‹ ì‹œìŠ¤í…œ ë¡œê·¸</div>
            <div id="log-container"></div>
        </div>

        <footer>
            Â© 2025 LDAP + Keycloak + OPA í†µí•© ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ | Gocache & Infinispan ê¸°ë°˜ ê³ ì„±ëŠ¥ ìºì‹±
        </footer>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let animationSpeed = 1000;
        let isAnimating = false;
        let currentScenario = 'random'; // random, no-cache, partial-cache, full-cache

        // ë…¸ë“œ ì •ì˜ (ë¨¼ì € ì •ì˜)
        const nodes = {
            client: { x: 100, y: 150, label: 'Client', color: '#3b82f6' },
            goBackend: { x: 250, y: 150, label: 'Go Backend', color: '#3b82f6' },
            gocache1: { x: 400, y: 150, label: 'Gocache\n(L1)', color: '#f59e0b' },
            keycloak: { x: 600, y: 150, label: 'Keycloak', color: '#ec4899' },
            infinispan: { x: 600, y: 300, label: 'Infinispan\n(L2 Cache)', color: '#8b5cf6' },
            ldap: { x: 800, y: 400, label: 'LDAP/AD', color: '#22c55e' },
            gocache2: { x: 250, y: 500, label: 'Gocache\n(Policy)', color: '#f59e0b' },
            redis: { x: 450, y: 500, label: 'Redis', color: '#dc2626' },
            opa: { x: 650, y: 500, label: 'OPA Engine', color: '#0284c7' }
        };

        // Canvas í¬ê¸° ì„¤ì •
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = 800;
            if (!isAnimating) drawStaticDiagram();
        }

        function drawNode(node, highlight = false) {
            ctx.save();
            
            if (highlight) {
                ctx.shadowColor = node.color;
                ctx.shadowBlur = 20;
            }

            // ë…¸ë“œ ë°•ìŠ¤
            ctx.fillStyle = node.color + '20';
            ctx.strokeStyle = node.color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.roundRect(node.x - 60, node.y - 30, 120, 60, 8);
            ctx.fill();
            ctx.stroke();

            // í…ìŠ¤íŠ¸
            ctx.fillStyle = node.color;
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const lines = node.label.split('\n');
            lines.forEach((line, i) => {
                ctx.fillText(line, node.x, node.y + (i - lines.length / 2 + 0.5) * 16);
            });

            ctx.restore();
        }

        function drawArrow(from, to, color, label = '', dashed = false, animate = false) {
            ctx.save();
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 3;
            
            if (dashed) {
                ctx.setLineDash([8, 4]);
            }

            if (animate) {
                ctx.shadowColor = color;
                ctx.shadowBlur = 10;
            }

            // í™”ì‚´í‘œ ê·¸ë¦¬ê¸°
            ctx.beginPath();
            ctx.moveTo(from.x, from.y);
            ctx.lineTo(to.x, to.y);
            ctx.stroke();

            // í™”ì‚´í‘œ ë¨¸ë¦¬
            const angle = Math.atan2(to.y - from.y, to.x - from.x);
            ctx.beginPath();
            ctx.moveTo(to.x, to.y);
            ctx.lineTo(to.x - 15 * Math.cos(angle - Math.PI / 6), to.y - 15 * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(to.x - 15 * Math.cos(angle + Math.PI / 6), to.y - 15 * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();

            // ë ˆì´ë¸”
            if (label) {
                const midX = (from.x + to.x) / 2;
                const midY = (from.y + to.y) / 2;
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.font = 'bold 12px Arial';
                const metrics = ctx.measureText(label);
                ctx.fillRect(midX - metrics.width / 2 - 4, midY - 10, metrics.width + 8, 20);
                ctx.strokeRect(midX - metrics.width / 2 - 4, midY - 10, metrics.width + 8, 20);
                ctx.fillStyle = color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(label, midX, midY);
            }

            ctx.restore();
        }

        function drawStaticDiagram() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ë°°ê²½ ì„¹ì…˜
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, 380);
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 380, canvas.width, 420);

            // ì„¹ì…˜ ì œëª©
            ctx.fillStyle = '#1f4788';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('ì¸ì¦ ë ˆì´ì–´ (Authentication)', 20, 30);
            
            ctx.fillStyle = '#0284c7';
            ctx.fillText('ì¸ê°€ ë ˆì´ì–´ (Authorization)', 20, 420);

            // ë…¸ë“œ ê·¸ë¦¬ê¸°
            Object.values(nodes).forEach(node => drawNode(node));

            // ì •ì  ì—°ê²°ì„ 
            drawArrow(nodes.client, nodes.goBackend, '#adb5bd', 'â‘  Token');
            drawArrow(nodes.goBackend, nodes.gocache1, '#adb5bd', 'â‘¡ Check');
            drawArrow(nodes.keycloak, nodes.infinispan, '#adb5bd', 'â‘¢ Check');
            drawArrow(nodes.goBackend, nodes.gocache2, '#adb5bd', 'â‘¤ Policy');
            drawArrow(nodes.gocache2, nodes.redis, '#adb5bd', 'â‘¥ Check');
            drawArrow(nodes.redis, nodes.opa, '#adb5bd', 'â‘¦ Evaluate');
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // ìµœëŒ€ 20ê°œë§Œ ìœ ì§€
            while (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function animateStep(from, to, color, label, type = 'info') {
            drawStaticDiagram();
            drawNode(from, true);
            drawNode(to, true);
            drawArrow(from, to, color, label, false, true);
            addLog(label, type);
            await sleep(animationSpeed);
        }

        async function startSimulation() {
            if (isAnimating) return;
            isAnimating = true;

            // ì‹œë‚˜ë¦¬ì˜¤ë³„ ìºì‹œ íˆíŠ¸ ê²°ì •
            let jwtCacheHit, infinispanHit, gocachePolicyHit, redisHit;
            
            switch(currentScenario) {
                case 'no-cache':
                    // ëª¨ë“  ìºì‹œ ë¯¸ìŠ¤
                    jwtCacheHit = false;
                    infinispanHit = false;
                    gocachePolicyHit = false;
                    redisHit = false;
                    addLog('âŒ ìºì‹œ ì—†ìŒ ëª¨ë“œ: ëª¨ë“  ìš”ì²­ì´ ì›ë³¸ ì†ŒìŠ¤ë¡œ ì´ë™', 'warning');
                    break;
                    
                case 'partial-cache':
                    // ì¼ë¶€ë§Œ ìºì‹œ íˆíŠ¸
                    jwtCacheHit = false;
                    infinispanHit = true;
                    gocachePolicyHit = false;
                    redisHit = true;
                    addLog('âš¡ ë¶€ë¶„ ìºì‹œ ëª¨ë“œ: L2 ìºì‹œ í™œìš©', 'info');
                    break;
                    
                case 'full-cache':
                    // ëª¨ë“  ìºì‹œ íˆíŠ¸
                    jwtCacheHit = true;
                    infinispanHit = true;
                    gocachePolicyHit = true;
                    redisHit = true;
                    addLog('âœ… ì „ì²´ ìºì‹œ ëª¨ë“œ: ìµœì  ì„±ëŠ¥', 'success');
                    break;
                    
                case 'random':
                default:
                    // ëœë¤ (80% íˆíŠ¸ìœ¨)
                    jwtCacheHit = Math.random() > 0.2;
                    infinispanHit = Math.random() > 0.3;
                    gocachePolicyHit = Math.random() > 0.15;
                    redisHit = Math.random() > 0.5;
                    addLog('ğŸ² ëœë¤ ëª¨ë“œ: ì‹¤ì œ í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜', 'info');
                    break;
            }

            addLog('ğŸš€ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘', 'info');
            
            // Step 1: Client â†’ Go Backend
            await animateStep(nodes.client, nodes.goBackend, '#3b82f6', 
                'â‘  HTTP Request + Access Token', 'info');

            // Step 2: Go Backend â†’ Gocache
            await animateStep(nodes.goBackend, nodes.gocache1, '#f59e0b',
                'â‘¡ JWT ê²€ì¦ ìºì‹œ í™•ì¸', 'info');

            if (jwtCacheHit) {
                // ìºì‹œ íˆíŠ¸ ì‹œë‚˜ë¦¬ì˜¤
                await animateStep(nodes.gocache1, nodes.goBackend, '#10b981',
                    'âœ“ Gocache íˆíŠ¸! (0.1ms)', 'success');
                document.getElementById('jwt-time').textContent = '0.1';
            } else {
                // ìºì‹œ ë¯¸ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤
                await animateStep(nodes.gocache1, nodes.keycloak, '#ef4444',
                    'âœ— Gocache ë¯¸ìŠ¤ â†’ Keycloak', 'error');
                
                await animateStep(nodes.keycloak, nodes.infinispan, '#8b5cf6',
                    'â‘¢ Infinispan ìºì‹œ í™•ì¸', 'info');

                if (infinispanHit) {
                    await animateStep(nodes.infinispan, nodes.keycloak, '#10b981',
                        'âœ“ Infinispan íˆíŠ¸ (1ms)', 'success');
                    await animateStep(nodes.keycloak, nodes.gocache1, '#10b981',
                        'JWT ê²€ì¦ ì™„ë£Œ', 'success');
                    await animateStep(nodes.gocache1, nodes.goBackend, '#f59e0b',
                        'Gocache ì €ì¥ (1.5ms)', 'success');
                    document.getElementById('jwt-time').textContent = '1.5';
                } else {
                    await animateStep(nodes.infinispan, nodes.ldap, '#ef4444',
                        'âœ— Infinispan ë¯¸ìŠ¤ â†’ LDAP', 'warning');
                    await animateStep(nodes.ldap, nodes.infinispan, '#22c55e',
                        'LDAP ë°ì´í„° ë°˜í™˜ (15ms)', 'success');
                    await animateStep(nodes.infinispan, nodes.keycloak, '#22c55e',
                        'Infinispan ì €ì¥ ì™„ë£Œ', 'success');
                    await animateStep(nodes.keycloak, nodes.gocache1, '#10b981',
                        'JWT ê²€ì¦ ì™„ë£Œ', 'success');
                    await animateStep(nodes.gocache1, nodes.goBackend, '#f59e0b',
                        'Gocache ì €ì¥ (15ms)', 'success');
                    document.getElementById('jwt-time').textContent = '15';
                }
            }

            // OPA ë ˆì´ì–´
            await sleep(animationSpeed / 2);
            addLog('--- ì¸ê°€ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ---', 'info');

            await animateStep(nodes.goBackend, nodes.gocache2, '#f59e0b',
                'â‘¤ ì •ì±… ê²°ì • ìºì‹œ í™•ì¸', 'info');

            if (gocachePolicyHit) {
                await animateStep(nodes.gocache2, nodes.goBackend, '#10b981',
                    'âœ“ Gocache ì •ì±… íˆíŠ¸! (0.05ms)', 'success');
                document.getElementById('opa-time').textContent = '0.05';
            } else {
                await animateStep(nodes.gocache2, nodes.redis, '#ef4444',
                    'âœ— Gocache ë¯¸ìŠ¤ â†’ Redis', 'warning');
                
                if (redisHit) {
                    await animateStep(nodes.redis, nodes.gocache2, '#10b981',
                        'âœ“ Redis íˆíŠ¸ (1ms)', 'success');
                    await animateStep(nodes.gocache2, nodes.goBackend, '#f59e0b',
                        'Gocache ì €ì¥ ì™„ë£Œ', 'success');
                    document.getElementById('opa-time').textContent = '1';
                } else {
                    await animateStep(nodes.redis, nodes.opa, '#ef4444',
                        'âœ— Redis ë¯¸ìŠ¤ â†’ OPA', 'error');
                    await animateStep(nodes.opa, nodes.redis, '#0284c7',
                        'Rego ì •ì±… í‰ê°€ (8ms)', 'info');
                    await animateStep(nodes.redis, nodes.gocache2, '#f59e0b',
                        'Redis ì €ì¥ ì™„ë£Œ', 'success');
                    await animateStep(nodes.gocache2, nodes.goBackend, '#f59e0b',
                        'Gocache ì €ì¥ ì™„ë£Œ (8ms)', 'success');
                    document.getElementById('opa-time').textContent = '8';
                }
            }

            // ìµœì¢… ì‘ë‹µ
            await animateStep(nodes.goBackend, nodes.client, '#10b981',
                'âœ“ 200 OK - Access Granted', 'success');

            // í†µê³„ ì—…ë°ì´íŠ¸
            const jwtTime = parseFloat(document.getElementById('jwt-time').textContent);
            const opaTime = parseFloat(document.getElementById('opa-time').textContent);
            const totalTime = jwtTime + opaTime + 1.85; // ê¸°ë³¸ ì˜¤ë²„í—¤ë“œ
            document.getElementById('total-time').textContent = totalTime.toFixed(2);

            // íˆíŠ¸ìœ¨ ê³„ì‚°
            let hits = 0;
            let total = 4;
            if (jwtCacheHit) hits++;
            if (infinispanHit) hits++;
            if (gocachePolicyHit) hits++;
            if (redisHit) hits++;
            const hitRate = Math.round((hits / total) * 100);
            document.getElementById('hit-rate').textContent = hitRate;

            addLog(`âœ… ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ (ì´ ${totalTime.toFixed(2)}ms, íˆíŠ¸ìœ¨ ${hitRate}%)`, 'success');
            isAnimating = false;
        }

        function resetSimulation() {
            isAnimating = false;
            drawStaticDiagram();
            document.getElementById('log-container').innerHTML = '';
            document.getElementById('jwt-time').textContent = '-';
            document.getElementById('opa-time').textContent = '-';
            document.getElementById('total-time').textContent = '-';
            document.getElementById('hit-rate').textContent = '-';
            addLog('ğŸ”„ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ', 'info');
            addLog(`í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤: ${getCurrentScenarioName()}`, 'info');
        }

        function getCurrentScenarioName() {
            const names = {
                'random': 'ğŸ² ëœë¤',
                'no-cache': 'âŒ ìºì‹œ ì—†ìŒ',
                'partial-cache': 'âš¡ ë¶€ë¶„ ìºì‹œ',
                'full-cache': 'âœ… ì „ì²´ ìºì‹œ'
            };
            return names[currentScenario];
        }

        function updateSpeed() {
            animationSpeed = parseInt(document.getElementById('speed').value);
        }

        function setScenario(scenario) {
            currentScenario = scenario;
            
            // ëª¨ë“  ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.btn-scenario').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ì„ íƒëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
            document.querySelector(`[data-scenario="${scenario}"]`).classList.add('active');
            
            // ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª… ë¡œê·¸
            const scenarioDescriptions = {
                'random': 'ëœë¤ ì‹œë‚˜ë¦¬ì˜¤: ì‹¤ì œ í™˜ê²½ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤ (80% ìºì‹œ íˆíŠ¸ìœ¨)',
                'no-cache': 'ìºì‹œ ì—†ìŒ ì‹œë‚˜ë¦¬ì˜¤: ëª¨ë“  ìš”ì²­ì´ ì›ë³¸ ì†ŒìŠ¤ë¡œ ì´ë™í•©ë‹ˆë‹¤',
                'partial-cache': 'ë¶€ë¶„ ìºì‹œ ì‹œë‚˜ë¦¬ì˜¤: ì¼ë¶€ ë ˆì´ì–´ë§Œ ìºì‹œ íˆíŠ¸í•©ë‹ˆë‹¤',
                'full-cache': 'ì „ì²´ ìºì‹œ ì‹œë‚˜ë¦¬ì˜¤: ëª¨ë“  ë ˆì´ì–´ì—ì„œ ìºì‹œ íˆíŠ¸í•©ë‹ˆë‹¤'
            };
            
            addLog(`ğŸ“‹ ${scenarioDescriptions[scenario]}`, 'info');
        }

        // CanvasRenderingContext2D.roundRect polyfill
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
                this.beginPath();
                this.moveTo(x + radius, y);
                this.arcTo(x + width, y, x + width, y + height, radius);
                this.arcTo(x + width, y + height, x, y + height, radius);
                this.arcTo(x, y + height, x, y, radius);
                this.arcTo(x, y, x + width, y, radius);
                this.closePath();
                return this;
            };
        }

        // ì´ˆê¸° ì„¤ì •
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        drawStaticDiagram();
        addLog('ğŸ¯ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ê³  ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•˜ì„¸ìš”.', 'success');
        addLog('ğŸ’¡ Tip: ê° ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¤í–‰í•˜ì—¬ ìºì‹±ì˜ ì„±ëŠ¥ ì˜í–¥ì„ ë¹„êµí•´ë³´ì„¸ìš”.', 'info');
    </script>
</body>
</html>
